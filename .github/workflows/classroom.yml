name: GitHub Classroom Workflow

on: 
  push:
    branches:
    - '*'
    - '!status'
    - '!feedback'

  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  build:
    name: Autograding
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    env:
      APP_ENV: ${{ secrets.APP_ENV }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      API_TOKEN: ${{ secrets.API_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight required secrets
        shell: bash
        run: |
          missing=0

          if [ -z "$APP_ENV" ]; then
            echo "::error::Missing APP_ENV. Set repo secrets from your .env with 'gh secret set -f .env' or via Settings -> Secrets and variables -> Actions." >&2
            missing=1
          fi

          if [ -z "$DATABASE_URL" ]; then
            echo "::error::Missing DATABASE_URL. Set repo secrets from your .env with 'gh secret set -f .env' or via Settings -> Secrets and variables -> Actions." >&2
            missing=1
          fi

          if [ -z "$API_TOKEN" ]; then
            echo "::error::Missing API_TOKEN. Set repo secrets from your .env with 'gh secret set -f .env' or via Settings -> Secrets and variables -> Actions." >&2
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Write runtime .env for autograding
        shell: bash
        run: |
          cat > .env <<EOF
          APP_ENV=${APP_ENV}
          DATABASE_URL=${DATABASE_URL}
          API_TOKEN=${API_TOKEN}
          EOF

      - name: Run autograding tests
        uses: education/autograding@v1
        continue-on-error: true

      - name: Fail if autograding is not full score
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/check-runs?per_page=100"
          summary=""

          for attempt in {1..20}; do
            summary=$(curl -fsSL \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "${api_url}" | jq -r '[.check_runs[] | select(.name == "Autograding") | (.output.summary // .output.text // "")][0] // ""')

            if [[ "$summary" =~ Points[[:space:]]+([0-9]+)\/([0-9]+) ]]; then
              earned="${BASH_REMATCH[1]}"
              total="${BASH_REMATCH[2]}"
              echo "Autograding score: ${earned}/${total}"

              if [ "$earned" -lt "$total" ]; then
                echo "::error::Autograding is not full score (${earned}/${total})."
                exit 1
              fi

              exit 0
            fi

            sleep 3
          done

          echo "::error::Could not read autograding score from check output."
          exit 1
